<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8">
  <title>Ponto App - Dashboard</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link href="/static/css/styles.css" rel="stylesheet">
</head>
<body>
  <div class="container">
    <h1>Ponto App</h1>
    <p>Distância máxima permitida: <strong>{{ max_dist }} m</strong></p>

    <div class="auth-links">
      <a href="/login">Login</a> | <a href="/cadastro">Cadastro</a>
    </div>

    <div class="buttons">
      <button onclick="registrar('entrada')">Registrar Entrada</button>
      <button onclick="registrar('saida_almoco')">Registrar Saída Almoço</button>
      <button onclick="registrar('retorno_almoco')">Registrar Retorno</button>
      <button onclick="registrar('saida_final')">Registrar Saída Final</button>
    </div>

    <div id="status"></div>

    <hr>
    <h3>Relatório</h3>
    <button onclick="buscarRelatorio()">Carregar Relatório</button>
    <pre id="rel"></pre>
  </div>

<script>
function getToken(){
  return localStorage.getItem('token') || '';
}

async function registrar(tipo) {
    const token = getToken();
    if (!token) { alert('Você precisa fazer login primeiro. Vá em /login'); return; }
    if (!navigator.geolocation) {
        alert("Seu navegador não suporta geolocalização.");
        return;
    }
    document.getElementById('status').innerText = 'Obtendo localização...';
    navigator.geolocation.getCurrentPosition(async function(pos) {
        const data = { tipo: tipo, lat: pos.coords.latitude, lng: pos.coords.longitude };
        try {
            const resp = await fetch('/registrar-ponto', {
                method: 'POST',
                headers: {'Content-Type':'application/json', 'Authorization': 'Bearer ' + token},
                body: JSON.stringify(data)
            });
            const json = await resp.json();
            if (resp.ok) {
                document.getElementById('status').innerText = json.sucesso + " (distância: " + (json.distancia_m || 0) + " m)";
            } else {
                document.getElementById('status').innerText = json.erro;
            }
        } catch (e) {
            document.getElementById('status').innerText = 'Erro ao contatar o servidor.';
        }
    }, function(err) {
        document.getElementById('status').innerText = 'Não conseguimos obter sua localização.';
    }, {enableHighAccuracy: true, timeout: 10000});
}

async function buscarRelatorio() {
    const token = getToken();
    if (!token) { alert('Você precisa fazer login primeiro. Vá em /login'); return; }
    const resp = await fetch('/relatorio', { headers: { 'Authorization': 'Bearer ' + token } });
    const json = await resp.json();
    document.getElementById('rel').innerText = JSON.stringify(json, null, 2);
}
</script>
</body>
</html>
